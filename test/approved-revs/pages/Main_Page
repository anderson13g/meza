== Get started ==

# Install meza: https://github.com/enterprisemediawiki/meza
# Run Approved Revs test setup: <code>sudo bash /opt/meza/test/approved-revs/run-test.sh</code>
# Open four browsers (like Firefox, Chrome, Internet Explorer and Opera). This makes it easy to login as multiple users simultaneously. You may also use incognito mode to count as a browser.
# Confirm all browser tabs on correct URL; confirm logged in to correct account (anonymous account, User:Basic, User:Editor, User:Admin)

= FIXME: Need examples of files and pages in special pages =

== Simple approvals ==

# User:Admin approve [[Initially unapproved page]]
# User:Admin approve different version [[Initially unapproved page]]
# User:Admin unapprove [[Initially unapproved page]]
# Verify logs reflect changes

=== File approvals ===

# User:Admin approve third revision of [[:[[:File:Test.png]]]]
# User:Admin confirm third revision visible of [[:File:Test.png]] on [[File redirects]], links work
# User:Basic repeat
# User:Admin approve second revision of [[:File:Test.png]]
# Verify logs reflect
# User:Editor confirm second revision visible of [[:File:Test.png]] on [[File redirects]], links work
# Anonymous repeat
# User:Admin approve first version of [[:File:Test.png]]
# User:Admin confirm first version visible of [[:File:Test.png]] on [[File redirects]], links work
# User:Admin unapprove [[:File:Test.png]]
# User:Basic confirm latest revision visible of [[:File:Test.png]] on [[File redirects]], links work

=== Unapprove message ===
# User:Admin view [[User:Basic]], verify no "this page is unapproved" message
# set $egApprovedRevsShowNotApprovedMessage = true;
## <code>sudo vim /opt/meza/htdocs/wikis/arevs/config/ApprovedRevsSettings.php</code>
## Uncomment "uncomment #1".
# User:Admin view [[User:Basic]], verify "this page is unapproved" message EXISTS
# User:Admin approve [[User:Basic]]
# User:Admin view [[User:Basic]], verify "this page is unapproved" replaced by appropriate message
# User:Basic approve [[User:Basic]]
# Verify logs reflect

=== Approval rights by category ===
# Verify Editor cannot approve [[With override]]
# User:Basic approve [[With override]]
# User:Editor approve [[Without override]]
# User:Basic approve [[Without override]]

=== Approval rights by SMW property ===
# Verify Basic cannot approve [[Expert info]]
# Uncomment "Expert info" setting
## <code>sudo vim /opt/meza/htdocs/wikis/arevs/config/ApprovedRevsSettings.php</code>
## Uncomment "uncomment #2".
# User:Basic approve [[Expert info]] semantic commit 1
# User:Editor verify correct semantic data on approved page
# User:Basic verify correct semantic data on latest page
# User:Editor confirm cannot approve
# User:Admin approve [[Expert info]] semantic commit 2
# Anonymous verify cannot approve
# Anonymous verify correct semantic data on approved page
# Admin verify correct semantic data on latest page
# Admin verify correct semantic data on Main Page: Test prop = {{#show: Expert info |? Test prop }}

=== Approvals by exclusive page ownership ===
# User:Admin approve [[Basic's page]]
# User:Basic approve [[Basic's page]]
# User:Editor verify cannot approve
# Anonymous verify cannot approve

=== Approvals by unexclusive page ownership ===
# User:Admin approve [[Not just Basic's]]
# User:Admin verify has view-link-to-latest
# User:Editor approve
# User:Editor verify has view-link-to-latest
# User:Basic approve
# User:Basic verify has view-link-to-latest
# Anonymous verify cannot approve
# Anonymous verify has view-link-to-latest

=== Don't allow viewing link to latest version ===
# Set viewlinktolatest permissionsas *=false, Editors=true, sysop=true
## <code>sudo vim /opt/meza/htdocs/wikis/arevs/config/ApprovedRevsSettings.php</code>
## Uncomment "uncomment #3".
# On [[Not just Basic's]],
## User:Admin verify has view-link-to-latest
## User:Editor verify has view-link-to-latest
## User:Basic verify DOES NOT have view-link-to-latest
## Anonymous verify DOES NOT have view-link-to-latest

== Testing $egApprovedRevsBlankIfUnapproved and $egApprovedRevsAutomaticApprovals ==
At the start of this section, automatic approvals are disallowed. Automatic approvals are affected by blank-if-unapproved, so it's important to test all four cases:

# auto-approvals = off, blank-if-unapproved = off
# auto-approvals = off, blank-if-unapproved = on
# auto-approvals = on, blank-if-unapproved = off
# auto-approvals = on, blank-if-unapproved = on

=== Off/Off: Disallow auto approvals for all users ===

# Default settings are Off/Off, no change required
# Admin create page [[New admin page]]; Verify no automatic approval
# Editor create page [[New editor page]]; Verify no automatic approval
# Basic create page [[New basic page]]; Verify no automatic approval
# Anonymous create [[New anonymous page]]; Verify no automatic approval

=== Off/Off: No auto approvals after edits and approvals ===

# User:Editor edit [[New editor page]], verify no auto-approval
# User:Editor approve [[New editor page]]
# User:Editor edit [[New editor page]] again
# Verify no auto-approval on [[New editor page]]

=== Off/On: No auto approvals, blank if unapproved ===

# Set Off/On
## <code>sudo vim /opt/meza/htdocs/wikis/arevs/config/ApprovedRevsSettings.php</code>
## Uncomment "uncomment #4".
# User:Editor view [[New editor page]], verify approved version showing
# User:Editor edit [[New editor page]], verify no auto-approval
# User:Editor unapprove [[New editor page]], verify blank
# User:Editor edit [[New editor page]], verify no auto-approval, still blank page
# User:Editor create [[Yet another editor page]], verify no auto approval, page is blank
# User:Editor edit [[Yet another editor page]] again, verify no auto approval, page is blank

=== On/Off: Allow auto-approvals, not blank if unapproved ===

# Set On/Off
## <code>sudo vim /opt/meza/htdocs/wikis/arevs/config/ApprovedRevsSettings.php</code>
## Uncomment "uncomment #5".
# Admin unapprove [[New admin page]] if required
# Admin edit [[New admin page]]; Verify no automatic approval (since it's unapproved and blank-if-unapproved is not set)
# Admin approve [[New admin page]]
# Admin edit [[New admin page]]; Verify automatic approval
# User:Admin create [[Another new admin page]]; Verify no automatic approval (since blank-if-unapproved = false)
# User:Basic create [[Another new basic page]]; Verify no automatic approval (User:Basic not allowed to approve pages in the main namespace and blank-if-unapproved = false)
# User:Basic edit [[Another new basic page]]; Verify no automatic approval

=== On/On: Allow auto-approvals, Blank if unapproved ===

# Anonymous verify [[Do not approve]] is not blank
# Set On/On
## <code>sudo vim /opt/meza/htdocs/wikis/arevs/config/ApprovedRevsSettings.php</code>
## Uncomment "uncomment #6".
# Anonymous verify [[Do not approve]] IS blank
# User:Admin edit [[Do not approve]]; verify auto-approval (since auto-approvals = true and blank-if-unapproved = true)

== Special Pages ==

=== [[Special:AdminLinks]] ===
# Verify links display properly and work

=== [[Special:ApprovedPages]] ===
# Verify no errors in "approved revision is not their latest"
# Verify no errors in "unapproved"
# Verify no errors in "all with an approved revision"
# Verify no errors in "undesignated approvals"

=== [[Special:ApprovedFiles]] ===
# Verify no errors in "approved revision is not their latest"
# Verify no errors in "unapproved"
# Verify no errors in "all with an approved revision"
# Verify no errors in "undesignated approvals"

=== Approve latest link in special pages ===
# Verify no "approve latest" link in Special:ApprovedPages -> Unapproved pages
# Verify no "approve latest" link in Special:ApprovedFiles -> Unapproved files
# Set $egApprovedRevsShowApproveLatest = true;
## <code>sudo vim /opt/meza/htdocs/wikis/arevs/config/ApprovedRevsSettings.php</code>
## Uncomment "uncomment #7".
# Verify presence of "approve latest" link in Special:ApprovedPages -> Unapproved pages
# Verify presence of "approve latest" link in Special:ApprovedFiles -> Unapproved files

=== Approve all pages ===
# Verify pages exist in Special:ApprovedPages -> Unapproved Pages
# Run ApprovedRevs/maintenance/approveAllPages.php
# Verify no pages in Special:ApprovedPages -> Unapproved Pages
